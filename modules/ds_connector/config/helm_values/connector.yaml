# should argo-cd applications be created?
argoApplications: false

################################################################################
# Sub-Chart configuration                                                      #
################################################################################

#* DONE
mongodb:
  deploymentEnabled: ${mongodb_enable}

  fullnameOverride: ${mongodb_name}

  ##############################################################################
  # Helm chart: mongodb                                                        #
  ##############################################################################
  mongodb:

    fullnameOverride: ${mongodb_name}

    # DB Authorization
    auth:
      enabled: ${mongodb_auth_enable}
      # Should use a Secret on production deployments
      rootPassword: ${mongodb_root_password}

    # Required for permissions to PVC
    podSecurityContext: #TODO: Check if this is needed
      enabled: true
      fsGroup: 1001
    
    containerSecurityContext: #TODO: Check if this is needed
      enabled: true
      runAsUser: 1001
      runAsGroup: 0
      runAsNonRoot: true

    # Set resources
    resources:
      limits:
        cpu: 200m
        memory: 512Mi

    persistence:
      enabled: true
      size: 8Gi

#* DONE
mysql:
  deploymentEnabled: ${mysql_enable}

  fullnameOverride: ${mysql_name}

  ##############################################################################
  # Helm chart: mysql                                                          #
  ##############################################################################
  mysql:
    
    fullnameOverride: ${mysql_name}
    
    auth:
      # Should use a Secret on production deployments
      rootPassword: ${mysql_root_password}
      password: ${mysql_password}

#* DONE
postgres:
  deploymentEnabled: ${postgresql_enable}

  fullnameOverride: ${postgresql_name}

  ##############################################################################
  # Helm chart: postgresql                                                     #
  ##############################################################################
  postgresql:

    fullnameOverride: ${postgresql_name}

    auth:
      # Credentials for postgres admin user
      postgresPassword: ${postgresql_root_password}

      enablePostgresUser: true
      # Should use a Secret for PWs on production deployments
      # Credentials for Keycloak DB
      username: ${postgresql_user_name}
      password: ${postgresql_user_password}

    # Init DB
    primary:
      initdb:
        scripts:
          create.sh: |
            psql postgresql://postgres:${postgresql_root_password}@localhost:5432 -c "CREATE DATABASE ${postgresql_db_name};"

#? DONE - check ingress tls secrects, waltid-certs ??
vcwaltid:
  deploymentEnabled: ${waltid_enable}

  fullnameOverride: ${waltid_name}

  # Organisation DID
  did: ${did_domain}
  
  # Ingress
  ingress:
    enabled: ${waltid_ingress}
    annotations:
      kubernetes.io/ingress.class: "nginx"
      # forcing everything to use ssl
      ingress.kubernetes.io/ssl-redirect: "true"
      # example annotations, allowing cert-manager to automatically create tls-certs
      kubernetes.io/tls-acme: "true"
    host: ${waltid_domain}
    # configure the ingress' tls
    tls:
      enabled: true
      # - secretName: ${waltid_secret_tls}
      #   hosts:
      #     - ${waltid_domain}
  
  # OpenShift Route
  route:
    enabled: false
    
  ##############################################################################
  # Helm chart: vcwaltid                                                       #
  ##############################################################################
  vcwaltid:

    fullnameOverride: ${waltid_name}

    # Persistence
    persistence:
      enabled: true
      pvc:
        size: 1Gi

    # List of templates to be created
    templates:
      GaiaXParticipantCredential.json: |
        {
          "@context": [
            "https://www.w3.org/2018/credentials/v1",
            "https://registry.lab.dsba.eu/development/api/trusted-shape-registry/v1/shapes/jsonld/trustframework#"
          ],
          "type": [
            "VerifiableCredential"
          ],
          "id": "did:web:raw.githubusercontent.com:egavard:payload-sign:master",
          "issuer": "did:web:raw.githubusercontent.com:egavard:payload-sign:master",
          "issuanceDate": "2023-03-21T12:00:00.148Z",
          "credentialSubject": {
            "id": "did:web:raw.githubusercontent.com:egavard:payload-sign:master",
            "type": "gx:LegalParticipant",
            "gx:legalName": "dsba compliant participant",
            "gx:legalRegistrationNumber": {
              "gx:vatID": "MYVATID"
            },
            "gx:headquarterAddress": {
              "gx:countrySubdivisionCode": "BE-BRU"
            },
            "gx:legalAddress": {
              "gx:countrySubdivisionCode": "BE-BRU"
            },
            "gx-terms-and-conditions:gaiaxTermsAndConditions": "70c1d713215f95191a11d38fe2341faed27d19e083917bc8732ca4fea4976700"
          }
        }
      NaturalPersonCredential.json: |
        {
          "@context": ["https://www.w3.org/2018/credentials/v1"],
          "credentialSchema": {
            "id": "https://raw.githubusercontent.com/FIWARE-Ops/tech-x-challenge/main/schema.json",
            "type": "FullJsonSchemaValidator2021"
          },
          "credentialSubject": {
            "type": "gx:NaturalParticipant",
            "familyName": "Happy",
            "firstName": "User",
            "roles": [{
              "names": ["LEGAL_REPRESENTATIVE"],
              "target": "did:web:onboarding"
             }]
          },
          "id": "urn:uuid:3add94f4-28ec-42a1-8704-4e4aa51006b4",
          "issued": "2021-08-31T00:00:00Z",
          "issuer": "did:ebsi:2A9BZ9SUe6BatacSpvs1V5CdjHvLpQ7bEsi2Jb6LdHKnQxaN",
          "validFrom": "2021-08-31T00:00:00Z",
          "issuanceDate": "2021-08-31T00:00:00Z",
          "type": ["VerifiableCredential", "LegalPersonCredential"]
        }
      MarketplaceUserCredential.json: |
        {
          "@context": ["https://www.w3.org/2018/credentials/v1"],
          "credentialSchema": {
            "id": "https://raw.githubusercontent.com/FIWARE-Ops/tech-x-challenge/main/schema.json",
            "type": "FullJsonSchemaValidator2021"
          },
          "credentialSubject": {
            "type": "gx:NaturalParticipant",
            "email": "normal-user@fiware.org",
            "familyName": "IPS",
            "firstName": "employee",
            "lastName": "IPS",
            "roles": [{
              "names": ["LEGAL_REPRESENTATIVE"],
              "target": "did:web:onboarding"
            }]
          },
          "id": "urn:uuid:3add94f4-28ec-42a1-8704-4e4aa51006b4",
          "issued": "2021-08-31T00:00:00Z",
          "issuer": "did:ebsi:2A9BZ9SUe6BatacSpvs1V5CdjHvLpQ7bEsi2Jb6LdHKnQxaN",
          "validFrom": "2021-08-31T00:00:00Z",
          "issuanceDate": "2021-08-31T00:00:00Z",
          "type": ["MarketplaceUserCredential"]
        }
      EmployeeCredential.json: |
        {
          "@context": ["https://www.w3.org/2018/credentials/v1"],
          "credentialSchema": {
            "id": "https://raw.githubusercontent.com/FIWARE-Ops/tech-x-challenge/main/schema.json",
            "type": "FullJsonSchemaValidator2021"
          },
          "credentialSubject": {
            "type": "gx:NaturalParticipant",
            "email": "normal-user@fiware.org",
            "familyName": "IPS",
            "firstName": "employee",
            "lastName": "IPS",
            "roles": [{
              "names": ["LEGAL_REPRESENTATIVE"],
              "target": "did:web:onboarding"
            }]
          },
          "id": "urn:uuid:3add94f4-28ec-42a1-8704-4e4aa51006b4",
          "issued": "2021-08-31T00:00:00Z",
          "issuer": "did:ebsi:2A9BZ9SUe6BatacSpvs1V5CdjHvLpQ7bEsi2Jb6LdHKnQxaN",
          "validFrom": "2021-08-31T00:00:00Z",
          "issuanceDate": "2021-08-31T00:00:00Z",
          "type": ["EmployeeCredential"]
        }

#* DONE
tm-forum-api:
  deploymentEnabled: ${tm_forum_api_enable}

  fullnameOverride: ${tm_forum_api_name}

  ##############################################################################
  # Helm chart: TM Forum API                                                   #
  ##############################################################################
  tm-forum-api:
    fullnameOverride: ${tm_forum_api_name}

################################################################################

#* DONE
orion-ld:
  deploymentEnabled: ${orionld_enable}

  fullnameOverride: ${orionld_name}
  
  ##############################################################################
  # Helm chart: mysql                                                          #
  ##############################################################################
  orion:

    fullnameOverride: ${orionld_name}

    broker:
      db:
        auth:
          user: root
          password: ${mongodb_root_password}
          mech: "SCRAM-SHA-1"
        hosts:
          - ${mongodb_name}

    initData: #TODO: Check if data is created in the DB
      initEnabled: false
      hook: post-install
      backoffLimit: 6
      entities:
        - name: deliveryorder_happypets001.json
          data: |
            {
              "id": "urn:ngsi-ld:DELIVERYORDER:HAPPYPETS001",
              "type": "DELIVERYORDER",
              "issuer": {
                "type": "Property",
                "value": "Happy Pets"
              },
              "destinee": {
                "type": "Property",
                "value": "Happy Pets customer via IPS"
              },
              "deliveryAddress": {
                "type": "Property",
                "value": {
                  "addressCountry": "DE",
                  "addressRegion": "Berlin",
                  "addressLocality": "Berlin",
                  "postalCode": "12345",
                  "streetAddress": "Customer Strasse 23"
                }
              },
              "originAddress": {
                "type": "Property",
                "value": {
                  "addressCountry": "DE",
                  "addressRegion": "Berlin",
                  "addressLocality": "Berlin",
                  "postalCode": "12345",
                  "streetAddress": "HappyPets Strasse 15"
                }
              },
              "pda": {
                "type": "Property",
                "value": "2021-10-03"
              },
              "pta": {
                "type": "Property",
                "value": "14:00:00"
              },
              "eda": {
                "type": "Property",
                "value": "2021-10-02"
              },
              "eta": {
                "type": "Property",
                "value": "14:00:00"
              },
              "@context": [
                "https://schema.lab.fiware.org/ld/context"
              ]
            }
                
        - name: deliveryorder_happypets002.json
          data: |
            {
              "id": "urn:ngsi-ld:DELIVERYORDER:HAPPYPETS002",
              "type": "DELIVERYORDER",
              "issuer": {
                "type": "Property",
                "value": "Happy Pets"
              },
              "destinee": {
                "type": "Property",
                "value": "Happy Pets 2nd customer via IPS"
              },
              "deliveryAddress": {
                "type": "Property",
                "value": {
                  "addressCountry": "DE",
                  "addressRegion": "Hamburg",
                  "addressLocality": "Hamburg",
                  "postalCode": "23456",
                  "streetAddress": "Customer Str. 19"
                }
              },
              "originAddress": {
                "type": "Property",
                "value": {
                  "addressCountry": "DE",
                  "addressRegion": "Berlin",
                  "addressLocality": "Berlin",
                  "postalCode": "12345",
                  "streetAddress": "HappyPets Strasse 15"
                }
              },
              "pda": {
                "type": "Property",
                "value": "2021-11-12"
              },
              "pta": {
                "type": "Property",
                "value": "11:00:00"
              },
              "eda": {
                "type": "Property",
                "value": "2021-11-12"
              },
              "eta": {
                "type": "Property",
                "value": "11:00:00"
              },
              "@context": [
                "https://schema.lab.fiware.org/ld/context"
              ]
            }

################################################################################

#* DONE
credentials-config-service:
  deploymentEnabled: ${ccs_enable}

  fullnameOverride: ${ccs_name}

  ##############################################################################
  # Helm chart: Credentials Config Service                                     #
  ##############################################################################
  credentials-config-service:

    fullnameOverride: ${ccs_name}

    # Database config
    database:
      persistence: true
      host: ${mysql_name}
      name: ${ccs_db_name}
      # Should use Secret in production environment
      username: root
      password: ${mysql_root_password}

#* DONE
trusted-issuers-list:
  deploymentEnabled: ${til_enable}

  fullnameOverride: ${til_name}

  ##############################################################################
  # Helm chart: Trusted Issuers List                                           #
  ##############################################################################
  trusted-issuers-list:

    fullnameOverride: ${til_name}

    # Ingress
    ingress:
      til:
        enabled: true
        annotations:
          kubernetes.io/ingress.class: nginx #FIXME: Ingress class not set as nginx
          # forcing everything to use ssl
          ingress.kubernetes.io/ssl-redirect: "true"
          # example annotations, allowing cert-manager to automatically create tls-certs
          kubernetes.io/tls-acme: "true"
        hosts:
          - host: ${til_domain}
            paths:
              - /
        tls:
          - secretName: ${til_secret_tls}
            hosts:
              - ${til_domain}
      tir:
        enabled: true
        annotations:
          kubernetes.io/ingress.class: "nginx"
          # forcing everything to use ssl
          ingress.kubernetes.io/ssl-redirect: "true"
          # example annotations, allowing cert-manager to automatically create tls-certs
          kubernetes.io/tls-acme: "true"
        hosts:
          - host: ${tir_domain}
            paths:
              - /
        tls:
          - secretName: ${tir_secret_tls}
            hosts:
              - ${tir_domain}

    # Database config
    database:
      persistence: true
      host: ${mysql_name}
      name: ${til_db_name}
      # Should use Secret in production environment
      username: root
      password: ${mysql_root_password}

    # Init data
    initData: #TODO: Check if data is created in the DB
      initEnabled: false
      hook: post-install
      backoffLimit: 6
      issuers:
        - name: mp_create
          issuer:
            did: "did:web:marketplace.dsba.fiware.dev:did"
            credentials:
              - validFor:
                  from: "2022-07-21T17:32:28Z"
                  to: "2040-07-21T17:32:28Z"
                credentialsType: "IpsActivationService"
                claims:
                  - name: "roles"
                    allowedValues: 
                      - - names:
                          - "CREATE_ISSUER"
                          target: ${did_domain}
              - validFor:
                  from: "2022-07-21T17:32:28Z"
                  to: "2040-07-21T17:32:28Z"
                credentialsType: "VerifiableCredential"

################################################################################

#* DONE
verifier:
  deploymentEnabled: ${verifier_enable}

  fullnameOverride: ${verifier_name}

  ##############################################################################
  # Helm chart: Verifier                                                       #
  ##############################################################################
  vcverifier:

    fullnameOverride: ${verifier_name}

    ingress:
      enabled: ${verifier_ingress}
      # ingressClassName: nginx
      annotations:
        kubernetes.io/ingress.class: nginx #FIXME: Ingress class not set as nginx
        # forcing everything to use ssl
        ingress.kubernetes.io/ssl-redirect: "true"
        # example annotations, allowing cert-manager to automatically create tls-certs
        kubernetes.io/tls-acme: "true"
      hosts:
        - host: ${verifier_domain}
          paths:
            - /
      tls:
        - hosts:
            - ${verifier_domain}
          secretName: ${verifier_secret_tls}

    deployment:

      # Logging
      logging:
        level: DEBUG
        pathsToSkip:
          - "/health"

      # Server config
      server:
        # Place external host here when publishing verifier with public URL
        host: https://${verifier_domain}

      # Walt-id config
      ssikit:
        auditorUrl: http://${waltid_name}:7003

      # Verifier config
      verifier:
        # URL endpoint of data space trusted issuers registry
        tirAddress: https://tir.dsba.fiware.dev/v3/issuers #TODO: Change to TPR URL
        # DID of organisation
        did: ${did_domain}

      # Config service
      configRepo:
        configEndpoint: http://${ccs_name}:8080/

#* DONE
contract-management:
  deploymentEnabled: ${contract_management_enable}

  fullnameOverride: ${contract_management_name}

  ##############################################################################
  # Helm chart: Contract Management                                            #
  ##############################################################################
  contract-management:

    fullnameOverride: ${contract_management_name}

    til:
      ## Type of Verifiable Credential necessary for accessing the service
      credentialType: VerifiableCredential
      ## Claims with permissions granted to given Verifiable Credential
      claims:
        ## DID of the target service that is requiring the permissions
        - target: ${did_domain}
          ## Roles that are added/allowed for the given service
          roles:
            - STANDARD_CUSTOMER
            - GOLD_CUSTOMER
    services:
      product:
        url: http://${tm_forum_api_name}-envoy:8080
      party:
        url: http://${tm_forum_api_name}-envoy:8080
      til:
        url: http://${til_name}:8080

################################################################################

#! The initialization parameters remain to be configured.
keycloak:
  deploymentEnabled: ${keycloak_enable}

  fullnameOverride: ${keycloak_name}

  # Config to create DID
  didConfig:
    # Enable creation of ConfigMap for loading the DID into walt-id
    # When disabling, also remove the load-did initContainer from the list above
    loadDidWebEnabled: true

    # Domain for DID web
    domain: ${waltid_domain}

    # x5u for DID web
    x5u: "https://${waltid_domain}/certs/tls.crt"

  ##############################################################################
  # Helm chart: Keycloak                                                       #
  ##############################################################################
  keycloak:

    fullnameOverride: ${keycloak_name}

    # Ingress
    ingress:
      enabled: ${keycloak_ingress}
      ingressClassName: nginx
      annotations:
        kubernetes.io/ingress.class: nginx
        # forcing everything to use ssl
        ingress.kubernetes.io/ssl-redirect: "true"
        # example annotations, allowing cert-manager to automatically create tls-certs
        kubernetes.io/tls-acme: "true"
      hostname: ${keycloak_domain}
      tls:
        - hosts:
            - ${keycloak_domain}
          secretName: ${keycloak_secret_tls}

    # Logging
    logging:
      level: DEBUG

    # Replica
    replicaCount: 1

    # Admin account
    auth:
      adminUser: ${keycloak_admin_user}
      adminPassword: ${keycloak_admin_password}
    
    # Config for external DB
    postgresql: # internal database
      enabled: false
    externalDatabase:
      host: ${postgresql_name}
      user: ${postgresql_user_name}
      password: ${postgresql_user_password}
      database: ${keycloak_db_name}

    # ENVs
    extraEnvVars:
    - name: KEYCLOAK_PROXY_ADDRESS_FORWARDING
      value: "true"
    - name: KEYCLOAK_LOG_LEVEL
      value: DEBUG
    - name: VCISSUER_ISSUER_DID
      value: ${did_domain}
    - name: VCISSUER_WALTID_ADDRESS
      value: "http://${waltid_name}"

    # Volumes
    # extraVolumes:
    #   - name: data
    #     emptyDir: {}
    #   - name: providers
    #     emptyDir: {}
    #   - name: did-secret
    #     secret:
    #       secretName: ${waltid_secret_tls}
    #   - name: profiles
    #     configMap:
    #       name: ips-dsc-keycloak-profile #TODO: Check 
    #   - name: did-config
    #     configMap:
    #       name: ips-dsc-keycloak-did-config #TODO: Check 

    # # Init containers for VC issuer and loading of DID
    # initContainers:
    #   - name: add-vc-issuer
    #     image: quay.io/fiware/keycloak-vc-issuer:0.5.0
    #     imagePullPolicy: Always
    #     volumeMounts:
    #       - name: providers
    #         mountPath: /target
    #   - name: load-did
    #     image: quay.io/opencloudio/curl:4.2.0-build.8
    #     imagePullPolicy: Always
    #     command:
    #       - /bin/sh
    #       - /opt/did/script/import.sh
    #     env:
    #       - name: WALTID_CORE_ADDRESS
    #         value: "${waltid_name}:7000"
    #     volumeMounts:
    #       - name: did-config
    #         mountPath: /opt/did/script
    #       - name: did-secret
    #         mountPath: /opt/did/secret

    # CLI config
    #! hard-coded parameter for fiware example
    keycloakConfigCli:
      enabled: false # TODO: Check if this is needed. True by default.
      
      # Realm config - either provide configuration or existing ConfigMap
      configuration:
        realm.json: |-
          {
            "id": "fiware-server",
            "realm": "fiware-server",
            "accountTheme": "siop-2",
            "displayName": "IPS Keycloak",
            "displayNameHtml": "<div class=\"kc-logo-text\"><span>IPS Keycloak</span></div>",
            "enabled": true,
            "attributes": {
              "frontendUrl": "https://ips-kc.dsba.aws.fiware.io"
            },
            "sslRequired": "none",
            "roles": {
              "realm": [
                {
                  "name": "user",
                  "description": "User privileges",
                  "composite": false,
                  "clientRole": false,
                  "containerId": "fiware-server",
                  "attributes": {}
                }
              ],
              "client": {
                "did:web:onboarding.dsba.fiware.dev:did": [
                  {
                    "name": "LEGAL_REPRESENTATIVE",
                    "description": "Is allowed to register participants",
                    "clientRole": true
                  },
                  {
                    "name": "EMPLOYEE",
                    "description": "Is allowed to see participants",
                    "clientRole": true
                  }
                ],
                "did:web:marketplace.dsba.fiware.dev:did": [
                  {
                    "name": "customer",
                    "description": "Is allowed to buy.",
                    "clientRole": true
                  },
                  {
                    "name": "seller",
                    "description": "Is allowed to offer.",
                    "clientRole": true
                  }
                ],
                ${did_domain}: [
                  {
                    "name": "STANDARD_CUSTOMER",
                    "description": "User to access IPS with read access",
                    "clientRole": true
                  },
                  {
                    "name": "GOLD_CUSTOMER",
                    "description": "User to access IPS with read/write access",
                    "clientRole": true
                  }
                ]
              }
            },
            "groups": [
              {
                "name": "admin",
                "path": "/admin",
                "realmRoles": [
                  "user"
                ]
              },
              {
                "name": "consumer",
                "path": "/consumer",
                "realmRoles": [
                  "user"
                ]
              }
            ],
            "users": [
              {
                "username": "the-lear",
                "enabled": true,
                "email": "lear@ips.org",
                "credentials": [
                  {
                    "type": "password",
                    "value": "the-lear"
                  }
                ],
                "clientRoles": {
                  "did:web:onboarding.dsba.fiware.dev:did": [
                    "LEGAL_REPRESENTATIVE",
                    "EMPLOYEE"
                  ],
                  "account": [
                    "view-profile",
                    "manage-account"
                  ]
                },
                "groups": [
                  "/admin",
                  "/consumer"
                ]
              },
              {
                "username": "legal-representative",
                "enabled": true,
                "email": "legal-representative@ips.org",
                "firstName": "Legal",
                "lastName": "IPSEmployee",
                "credentials": [
                  {
                    "type": "password",
                    "value": "legal-representative"
                  }
                ],
                "clientRoles": {
                  "did:web:marketplace.dsba.fiware.dev:did" : [
                    "customer",
                    "seller"
                  ],
                  "did:web:onboarding.dsba.fiware.dev:did": [
                    "LEGAL_REPRESENTATIVE"
                  ],
                  "account": [
                    "view-profile",
                    "manage-account"
                  ]
                },
                "groups": [
                  "/admin",
                  "/consumer"
                ]
              },
              {
                "username": "standard-employee",
                "enabled": true,
                "email": "standard-employee@ips.org",
                "credentials": [
                  {
                    "type": "password",
                    "value": "standard-employee"
                  }
                ],
                "clientRoles": {
                  "did:web:onboarding.dsba.fiware.dev:did": [
                    "EMPLOYEE"
                  ],
                  ${did_domain}: [
                    "GOLD_CUSTOMER"
                  ],
                  "account": [
                    "view-profile",
                    "manage-account"
                  ]
                },
                "groups": [
                  "/consumer"
                ]
              }
            ],
            "clients": [
              {
                "clientId": ${did_domain},
                "enabled": true,
                "description": "Client for internal users",
                "surrogateAuthRequired": false,
                "alwaysDisplayInConsole": false,
                "clientAuthenticatorType": "client-secret",
                "defaultRoles": [],
                "redirectUris": [],
                "webOrigins": [],
                "notBefore": 0,
                "bearerOnly": false,
                "consentRequired": false,
                "standardFlowEnabled": true,
                "implicitFlowEnabled": false,
                "directAccessGrantsEnabled": false,
                "serviceAccountsEnabled": false,
                "publicClient": false,
                "frontchannelLogout": false,
                "protocol": "SIOP-2",
                "attributes": {
                    "client.secret.creation.time": "1675260539",
                    "expiryInMin": "3600",
                    "vctypes_EmployeeCredential": "ldp_vc,jwt_vc_json",
                    "EmployeeCredential_claims": "email,firstName,familyName,roles"
                },
                "authenticationFlowBindingOverrides": {},
                "fullScopeAllowed": true,
                "nodeReRegistrationTimeout": -1,
                "defaultClientScopes": [],
                "optionalClientScopes": []
              },
              {
                "clientId": "did:web:marketplace.dsba.fiware.dev:did",
                "enabled": true,
                "description": "Client to connect to the marketplace",
                "surrogateAuthRequired": false,
                "alwaysDisplayInConsole": false,
                "clientAuthenticatorType": "client-secret",
                "defaultRoles": [],
                "redirectUris": [],
                "webOrigins": [],
                "notBefore": 0,
                "bearerOnly": false,
                "consentRequired": false,
                "standardFlowEnabled": true,
                "implicitFlowEnabled": false,
                "directAccessGrantsEnabled": false,
                "serviceAccountsEnabled": false,
                "publicClient": false,
                "frontchannelLogout": false,
                "protocol": "SIOP-2",
                "attributes": {
                    "client.secret.creation.time": "1675260539",
                    "expiryInMin": "3600",
                    "vctypes_MarketplaceUserCredential": "ldp_vc,jwt_vc_json",
                    "MarketplaceUserCredential_claims": "email,firstName,lastName,roles"
                },
                "authenticationFlowBindingOverrides": {},
                "fullScopeAllowed": true,
                "nodeReRegistrationTimeout": -1,
                "defaultClientScopes": [],
                "optionalClientScopes": []
              },
              {
                "clientId": "did:web:onboarding.dsba.fiware.dev:did",
                "enabled": true,
                "description": "Client to connect the onboarding service at portal.dsba.fiware.dev",
                "surrogateAuthRequired": false,
                "alwaysDisplayInConsole": false,
                "clientAuthenticatorType": "client-secret",
                "defaultRoles": [],
                "redirectUris": [],
                "webOrigins": [],
                "notBefore": 0,
                "bearerOnly": false,
                "consentRequired": false,
                "standardFlowEnabled": true,
                "implicitFlowEnabled": false,
                "directAccessGrantsEnabled": false,
                "serviceAccountsEnabled": false,
                "publicClient": false,
                "frontchannelLogout": false,
                "protocol": "SIOP-2",
                "attributes": {
                    "client.secret.creation.time": "1675260539",
                    "expiryInMin": "3600",
                    "vctypes_NaturalPersonCredential": "ldp_vc,jwt_vc_json",
                    "vctypes_GaiaXParticipantCredential": "ldp_vc,jwt_vc_json",
                    "vc_subjectDid": "did:web:packetdelivery.dsba.fiware.dev:did",
                    "vc_gx:legalName": "Packet Delivery Company Inc.",
                    "GaiaXParticipantCredential_claims": "subjectDid,gx:legalName",
                    "NaturalPersonCredential_claims": "email,firstName,familyName,roles"
                },
                "authenticationFlowBindingOverrides": {},
                "fullScopeAllowed": true,
                "nodeReRegistrationTimeout": -1,
                "defaultClientScopes": [],
                "optionalClientScopes": []
              },
              {
                "clientId": "did:web:marketplace.dsba.fiware.dev:did",
                "enabled": true,
                "description": "Client to connect to the marketplace",
                "surrogateAuthRequired": false,
                "alwaysDisplayInConsole": false,
                "clientAuthenticatorType": "client-secret",
                "defaultRoles": [],
                "redirectUris": [],
                "webOrigins": [],
                "notBefore": 0,
                "bearerOnly": false,
                "consentRequired": false,
                "standardFlowEnabled": true,
                "implicitFlowEnabled": false,
                "directAccessGrantsEnabled": false,
                "serviceAccountsEnabled": false,
                "publicClient": false,
                "frontchannelLogout": false,
                "protocol": "SIOP-2",
                "attributes": {
                    "client.secret.creation.time": "1675260539",
                    "expiryInMin": "3600",
                    "vctypes_MarketplaceUserCredential": "ldp_vc,jwt_vc_json",
                    "MarketplaceUserCredential_claims": "email,firstName,lastName,roles"
                },
                "authenticationFlowBindingOverrides": {},
                "fullScopeAllowed": true,
                "nodeReRegistrationTimeout": -1,
                "defaultClientScopes": [],
                "optionalClientScopes": []
              }
            ],
            "clientScopes": [
              {
                "name": "fiware-scope",
                "protocol": "openid-connect",
                "attributes": {
                  "include.in.token.scope": "true",
                  "display.on.consent.screen": "false"
                },
                "protocolMappers": [
                  {
                    "name": "fiware-scope-object",
                    "protocol": "openid-connect",
                    "protocolMapper": "oidc-script-based-protocol-mapper",
                    "consentRequired": false,
                    "config": {
                      "userinfo.token.claim": "true",
                      "multivalued": "true",
                      "id.token.claim": "true",
                      "access.token.claim": "true",
                      "claim.name": "fiware-scope-object",
                      "script": "/**\n * Available variables: \n * user - the current user\n * realm - the current realm\n * token - the current token\n * userSession - the current userSession\n * keycloakSession - the current userSession\n */\n\nvar ArrayList = Java.type(\"java.util.ArrayList\");\nvar fiware_scope = new ArrayList();\n\nvar forEach = Array.prototype.forEach;\n\nvar fiware_service;\nvar fiware_servicepath;\nvar fiware_entry;\nvar roles = '';\n\nvar orion_client = realm.getClientByClientId('orion-pep');\n\nfiware_service = user.getFirstAttribute('fiware-service');\nfiware_servicepath = user.getFirstAttribute('fiware-servicepath');\nif (fiware_service !== null && fiware_servicepath !== null) {\n\n    fiware_entry = {\n        \"fiware-service\": fiware_service,\n        \"fiware-servicepath\": fiware_servicepath\n    };\n\n    var roleModels = user.getClientRoleMappings(orion_client);\n    if (roleModels.size() > 0) {\n        forEach.call(\n            user.getClientRoleMappings(orion_client).toArray(),\n            function (role) {\n                roles = roles + role.getName() + \",\";\n            }\n        );\n        roles = roles.substring(0, roles.length - 1);\n        fiware_entry[\"orion-roles\"] = roles;\n        roles = '';\n    }\n\n    fiware_scope.add(JSON.stringify(fiware_entry));\n    fiware_entry = {};\n}\n\nforEach.call(\n    user.getGroups().toArray(),\n    function (group) {\n\n        fiware_service = group.getFirstAttribute('fiware-service');\n        fiware_servicepath = group.getFirstAttribute('fiware-servicepath');\n        if (fiware_service !== null && fiware_servicepath !== null) {\n            fiware_entry = {\n                \"fiware-service\": fiware_service,\n                \"fiware-servicepath\": fiware_servicepath\n            };\n\n            var roleModels = group.getClientRoleMappings(orion_client);\n            if (roleModels.size() > 0) {\n                forEach.call(\n                    group.getClientRoleMappings(orion_client).toArray(),\n                    function (role) {\n                        roles = roles + role.getName() + \",\";\n                    }\n                );\n                roles = roles.substring(0, roles.length - 1);\n                fiware_entry[\"orion-roles\"] = roles;\n                roles = '';\n            }\n\n            fiware_scope.add(JSON.stringify(fiware_entry));\n            fiware_entry = {};\n        } else if (group.getParentId() !== null) {\n            fiware_service = group.getParent().getFirstAttribute('fiware-service');\n            fiware_servicepath = group.getParent().getFirstAttribute('fiware-servicepath');\n\n            if (fiware_service !== null && fiware_servicepath !== null) {\n                fiware_entry = {\n                    \"fiware-service\": fiware_service,\n                    \"fiware-servicepath\": fiware_servicepath\n                };\n                var subroleModels = group.getClientRoleMappings(orion_client);\n                if (subroleModels.size() > 0) {\n                    forEach.call(\n                        group.getClientRoleMappings(orion_client).toArray(),\n                        function (role) {\n                            roles = roles + role.getName() + \",\";\n                        }\n                    );\n                    roles = roles.substring(0, roles.length - 1);\n                    fiware_entry[\"orion-roles\"] = roles;\n                    roles = '';\n                }\n\n                fiware_scope.add(JSON.stringify(fiware_entry));\n                fiware_entry = '';\n            }\n        }\n    }\n);\n\nexports = fiware_scope;"
                    }
                  }
                ]
              },
              {
                "name": "offline_access",
                "description": "OpenID Connect built-in scope: offline_access",
                "protocol": "openid-connect",
                "attributes": {
                  "consent.screen.text": "offlineAccessScopeConsentText", #TODO: it was a variable
                  "display.on.consent.screen": "true"
                }
              },
              {
                "name": "microprofile-jwt",
                "description": "Microprofile - JWT built-in scope",
                "protocol": "openid-connect",
                "attributes": {
                  "include.in.token.scope": "true",
                  "display.on.consent.screen": "false"
                },
                "protocolMappers": [
                  {
                    "name": "upn",
                    "protocol": "openid-connect",
                    "protocolMapper": "oidc-usermodel-property-mapper",
                    "consentRequired": false,
                    "config": {
                      "userinfo.token.claim": "true",
                      "user.attribute": "username",
                      "id.token.claim": "true",
                      "access.token.claim": "true",
                      "claim.name": "upn",
                      "jsonType.label": "String"
                    }
                  },
                  {
                    "name": "groups",
                    "protocol": "openid-connect",
                    "protocolMapper": "oidc-usermodel-realm-role-mapper",
                    "consentRequired": false,
                    "config": {
                      "multivalued": "true",
                      "user.attribute": "foo",
                      "id.token.claim": "true",
                      "access.token.claim": "true",
                      "claim.name": "groups",
                      "jsonType.label": "String"
                    }
                  }
                ]
              },
              {
                "name": "roles",
                "description": "OpenID Connect scope for add user roles to the access token",
                "protocol": "openid-connect",
                "attributes": {
                  "include.in.token.scope": "false",
                  "display.on.consent.screen": "true",
                  "consent.screen.text": "rolesScopeConsentText" #TODO: it was a variable
                },
                "protocolMappers": [
                  {
                    "name": "audience resolve",
                    "protocol": "openid-connect",
                    "protocolMapper": "oidc-audience-resolve-mapper",
                    "consentRequired": false,
                    "config": {}
                  },
                  {
                    "name": "client roles",
                    "protocol": "openid-connect",
                    "protocolMapper": "oidc-usermodel-client-role-mapper",
                    "consentRequired": false,
                    "config": {
                      "user.attribute": "foo",
                      "access.token.claim": "true",
                      "claim.name": "resource_access.client_id.roles", #TODO: it was a variable (client_id)
                      "jsonType.label": "String",
                      "multivalued": "true"
                    }
                  },
                  {
                    "name": "realm roles",
                    "protocol": "openid-connect",
                    "protocolMapper": "oidc-usermodel-realm-role-mapper",
                    "consentRequired": false,
                    "config": {
                      "user.attribute": "foo",
                      "access.token.claim": "true",
                      "claim.name": "realm_access.roles",
                      "jsonType.label": "String",
                      "multivalued": "true"
                    }
                  }
                ]
              },
              {
                "name": "email",
                "description": "OpenID Connect built-in scope: email",
                "protocol": "openid-connect",
                "attributes": {
                  "include.in.token.scope": "true",
                  "display.on.consent.screen": "true",
                  "consent.screen.text": "emailScopeConsentText" #TODO: it was a variable
                },
                "protocolMappers": [
                  {
                    "name": "email",
                    "protocol": "openid-connect",
                    "protocolMapper": "oidc-usermodel-property-mapper",
                    "consentRequired": false,
                    "config": {
                      "userinfo.token.claim": "true",
                      "user.attribute": "email",
                      "id.token.claim": "true",
                      "access.token.claim": "true",
                      "claim.name": "email",
                      "jsonType.label": "String"
                    }
                  },
                  {
                    "name": "email verified",
                    "protocol": "openid-connect",
                    "protocolMapper": "oidc-usermodel-property-mapper",
                    "consentRequired": false,
                    "config": {
                      "userinfo.token.claim": "true",
                      "user.attribute": "emailVerified",
                      "id.token.claim": "true",
                      "access.token.claim": "true",
                      "claim.name": "email_verified",
                      "jsonType.label": "boolean"
                    }
                  }
                ]
              },
              {
                "name": "phone",
                "description": "OpenID Connect built-in scope: phone",
                "protocol": "openid-connect",
                "attributes": {
                  "include.in.token.scope": "true",
                  "display.on.consent.screen": "true",
                  "consent.screen.text": "phoneScopeConsentText" #TODO: it was a variable
                },
                "protocolMappers": [
                  {
                    "name": "phone number verified",
                    "protocol": "openid-connect",
                    "protocolMapper": "oidc-usermodel-attribute-mapper",
                    "consentRequired": false,
                    "config": {
                      "userinfo.token.claim": "true",
                      "user.attribute": "phoneNumberVerified",
                      "id.token.claim": "true",
                      "access.token.claim": "true",
                      "claim.name": "phone_number_verified",
                      "jsonType.label": "boolean"
                    }
                  },
                  {
                    "name": "phone number",
                    "protocol": "openid-connect",
                    "protocolMapper": "oidc-usermodel-attribute-mapper",
                    "consentRequired": false,
                    "config": {
                      "userinfo.token.claim": "true",
                      "user.attribute": "phoneNumber",
                      "id.token.claim": "true",
                      "access.token.claim": "true",
                      "claim.name": "phone_number",
                      "jsonType.label": "String"
                    }
                  }
                ]
              },
              {
                "name": "address",
                "description": "OpenID Connect built-in scope: address",
                "protocol": "openid-connect",
                "attributes": {
                  "include.in.token.scope": "true",
                  "display.on.consent.screen": "true",
                  "consent.screen.text": "addressScopeConsentText" #TODO: it was a variable
                },
                "protocolMappers": [
                  {
                    "name": "address",
                    "protocol": "openid-connect",
                    "protocolMapper": "oidc-address-mapper",
                    "consentRequired": false,
                    "config": {
                      "user.attribute.formatted": "formatted",
                      "user.attribute.country": "country",
                      "user.attribute.postal_code": "postal_code",
                      "userinfo.token.claim": "true",
                      "user.attribute.street": "street",
                      "id.token.claim": "true",
                      "user.attribute.region": "region",
                      "access.token.claim": "true",
                      "user.attribute.locality": "locality"
                    }
                  }
                ]
              },
              {
                "name": "role_list",
                "description": "SAML role list",
                "protocol": "saml",
                "attributes": {
                  "consent.screen.text": "samlRoleListScopeConsentText", #TODO: it was a variable
                  "display.on.consent.screen": "true"
                },
                "protocolMappers": [
                  {
                    "name": "role list",
                    "protocol": "saml",
                    "protocolMapper": "saml-role-list-mapper",
                    "consentRequired": false,
                    "config": {
                      "single": "false",
                      "attribute.nameformat": "Basic",
                      "attribute.name": "Role"
                    }
                  }
                ]
              },
              {
                "name": "profile",
                "description": "OpenID Connect built-in scope: profile",
                "protocol": "openid-connect",
                "attributes": {
                  "include.in.token.scope": "true",
                  "display.on.consent.screen": "true",
                  "consent.screen.text": "profileScopeConsentText" #TODO: it was a variable
                },
                "protocolMappers": [
                  {
                    "name": "zoneinfo",
                    "protocol": "openid-connect",
                    "protocolMapper": "oidc-usermodel-attribute-mapper",
                    "consentRequired": false,
                    "config": {
                      "userinfo.token.claim": "true",
                      "user.attribute": "zoneinfo",
                      "id.token.claim": "true",
                      "access.token.claim": "true",
                      "claim.name": "zoneinfo",
                      "jsonType.label": "String"
                    }
                  },
                  {
                    "name": "nickname",
                    "protocol": "openid-connect",
                    "protocolMapper": "oidc-usermodel-attribute-mapper",
                    "consentRequired": false,
                    "config": {
                      "userinfo.token.claim": "true",
                      "user.attribute": "nickname",
                      "id.token.claim": "true",
                      "access.token.claim": "true",
                      "claim.name": "nickname",
                      "jsonType.label": "String"
                    }
                  },
                  {
                    "name": "profile",
                    "protocol": "openid-connect",
                    "protocolMapper": "oidc-usermodel-attribute-mapper",
                    "consentRequired": false,
                    "config": {
                      "userinfo.token.claim": "true",
                      "user.attribute": "profile",
                      "id.token.claim": "true",
                      "access.token.claim": "true",
                      "claim.name": "profile",
                      "jsonType.label": "String"
                    }
                  },
                  {
                    "name": "full name",
                    "protocol": "openid-connect",
                    "protocolMapper": "oidc-full-name-mapper",
                    "consentRequired": false,
                    "config": {
                      "id.token.claim": "true",
                      "access.token.claim": "true",
                      "userinfo.token.claim": "true"
                    }
                  },
                  {
                    "name": "birthdate",
                    "protocol": "openid-connect",
                    "protocolMapper": "oidc-usermodel-attribute-mapper",
                    "consentRequired": false,
                    "config": {
                      "userinfo.token.claim": "true",
                      "user.attribute": "birthdate",
                      "id.token.claim": "true",
                      "access.token.claim": "true",
                      "claim.name": "birthdate",
                      "jsonType.label": "String"
                    }
                  },
                  {
                    "name": "family name",
                    "protocol": "openid-connect",
                    "protocolMapper": "oidc-usermodel-property-mapper",
                    "consentRequired": false,
                    "config": {
                      "userinfo.token.claim": "true",
                      "user.attribute": "lastName",
                      "id.token.claim": "true",
                      "access.token.claim": "true",
                      "claim.name": "family_name",
                      "jsonType.label": "String"
                    }
                  },
                  {
                    "name": "picture",
                    "protocol": "openid-connect",
                    "protocolMapper": "oidc-usermodel-attribute-mapper",
                    "consentRequired": false,
                    "config": {
                      "userinfo.token.claim": "true",
                      "user.attribute": "picture",
                      "id.token.claim": "true",
                      "access.token.claim": "true",
                      "claim.name": "picture",
                      "jsonType.label": "String"
                    }
                  },
                  {
                    "name": "website",
                    "protocol": "openid-connect",
                    "protocolMapper": "oidc-usermodel-attribute-mapper",
                    "consentRequired": false,
                    "config": {
                      "userinfo.token.claim": "true",
                      "user.attribute": "website",
                      "id.token.claim": "true",
                      "access.token.claim": "true",
                      "claim.name": "website",
                      "jsonType.label": "String"
                    }
                  },
                  {
                    "name": "locale",
                    "protocol": "openid-connect",
                    "protocolMapper": "oidc-usermodel-attribute-mapper",
                    "consentRequired": false,
                    "config": {
                      "userinfo.token.claim": "true",
                      "user.attribute": "locale",
                      "id.token.claim": "true",
                      "access.token.claim": "true",
                      "claim.name": "locale",
                      "jsonType.label": "String"
                    }
                  },
                  {
                    "name": "username",
                    "protocol": "openid-connect",
                    "protocolMapper": "oidc-usermodel-property-mapper",
                    "consentRequired": false,
                    "config": {
                      "userinfo.token.claim": "true",
                      "user.attribute": "username",
                      "id.token.claim": "true",
                      "access.token.claim": "true",
                      "claim.name": "preferred_username",
                      "jsonType.label": "String"
                    }
                  },
                  {
                    "name": "given name",
                    "protocol": "openid-connect",
                    "protocolMapper": "oidc-usermodel-property-mapper",
                    "consentRequired": false,
                    "config": {
                      "userinfo.token.claim": "true",
                      "user.attribute": "firstName",
                      "id.token.claim": "true",
                      "access.token.claim": "true",
                      "claim.name": "given_name",
                      "jsonType.label": "String"
                    }
                  },
                  {
                    "name": "updated at",
                    "protocol": "openid-connect",
                    "protocolMapper": "oidc-usermodel-attribute-mapper",
                    "consentRequired": false,
                    "config": {
                      "userinfo.token.claim": "true",
                      "user.attribute": "updatedAt",
                      "id.token.claim": "true",
                      "access.token.claim": "true",
                      "claim.name": "updated_at",
                      "jsonType.label": "String"
                    }
                  },
                  {
                    "name": "middle name",
                    "protocol": "openid-connect",
                    "protocolMapper": "oidc-usermodel-attribute-mapper",
                    "consentRequired": false,
                    "config": {
                      "userinfo.token.claim": "true",
                      "user.attribute": "middleName",
                      "id.token.claim": "true",
                      "access.token.claim": "true",
                      "claim.name": "middle_name",
                      "jsonType.label": "String"
                    }
                  },
                  {
                    "name": "gender",
                    "protocol": "openid-connect",
                    "protocolMapper": "oidc-usermodel-attribute-mapper",
                    "consentRequired": false,
                    "config": {
                      "userinfo.token.claim": "true",
                      "user.attribute": "gender",
                      "id.token.claim": "true",
                      "access.token.claim": "true",
                      "claim.name": "gender",
                      "jsonType.label": "String"
                    }
                  }
                ]
              },
              {
                "name": "web-origins",
                "description": "OpenID Connect scope for add allowed web origins to the access token",
                "protocol": "openid-connect",
                "attributes": {
                  "include.in.token.scope": "false",
                  "display.on.consent.screen": "false",
                  "consent.screen.text": ""
                },
                "protocolMappers": [
                  {
                    "name": "allowed web origins",
                    "protocol": "openid-connect",
                    "protocolMapper": "oidc-allowed-origins-mapper",
                    "consentRequired": false,
                    "config": {}
                  }
                ]
              }
            ],
            "defaultDefaultClientScopes": [
              "roles",
              "role_list",
              "email",
              "web-origins",
              "profile"
            ],
            "defaultOptionalClientScopes": [
              "microprofile-jwt",
              "phone",
              "address",
              "offline_access"
            ]
          }

################################################################################

#! ERROR
keyrock:
  # Enable the deployment of application: keyrock
  deploymentEnabled: ${keyrock_enable}

  ##############################################################################
  # Helm chart: Keyrock                                                        #
  ##############################################################################
  keyrock:
    fullnameOverride: ${keyrock_name}

    # External hostname of Keyrock
    host: https://${keyrock_domain}

    # Ingress
    ingress:
      enabled: ${keyrock_ingress}
      annotations:
        kubernetes.io/ingress.class: nginx #FIXME: Ingress class not set as nginx
        # forcing everything to use ssl
        ingress.kubernetes.io/ssl-redirect: "true"
        # example annotations, allowing cert-manager to automatically create tls-certs
        kubernetes.io/tls-acme: "true"
      hosts:
        - host: ${keyrock_domain}
          paths:
            - /
      tls:
        - hosts:
            - ${keyrock_domain}
          secretName: ${keyrock_secret_tls}
    
    # MySQL DB config
    db:
      user: root
      password: ${mysql_root_password}
      host: ${mysql_name}

    # Admin user to be created
    admin:
      user: ${keyrock_admin_user}
      password: ${keyrock_admin_password}
      email: ${keyrock_admin_email}

    ## Theme configuration for Keyrock
    theme:
      ## -- Enable theme
      enabled: false

    ## Configuration of Authorisation Registry (AR)
    authorisationRegistry:
      # -- Enable usage of authorisation registry
      enabled: true
      # -- Identifier (EORI) of AR
      identifier: ${did_domain}
      # -- URL of AR
      url: "internal"

    ## Configuration of iSHARE Satellite
    satellite:
      # -- Enable usage of satellite
      enabled: true
      # -- Identifier (EORI) of satellite
      identifier: "EU.EORI.FIWARESATELLITE"
      # -- URL of satellite
      url: "https://tir.dsba.fiware.dev" #TODO: Change to TPR URL
      # -- Token endpoint of satellite
      tokenEndpoint: "https://tir.dsba.fiware.dev/token"
      # -- Parties endpoint of satellite
      partiesEndpoint: "https://tir.dsba.fiware.dev/parties"

    ## -- Configuration of local key and certificate for validation and generation of tokens
    token:
      # -- Enable storage of local key and certificate
      enabled: false

    # ENV variables for Keyrock
    additionalEnvVars:
      - name: IDM_TITLE
        value: "IPS AR"
      - name: IDM_DEBUG
        value: "true"
      - name: DEBUG
        value: "*"
      - name: IDM_DB_NAME
        value: ${keyrock_db_name}
      - name: IDM_DB_SEED
        value: "true"
      - name: IDM_SERVER_MAX_HEADER_SIZE
        value: "32768"
      - name: IDM_PR_CLIENT_ID
        value: ${did_domain}
      - name: IDM_PR_CLIENT_KEY
        valueFrom:
            secretKeyRef:
              name: ${waltid_secret_tls}
              key: tls.key
      - name: IDM_PR_CLIENT_CRT
        valueFrom:
            secretKeyRef:
              name: ${waltid_secret_tls}
              key: tls.crt

    # Init data
    initData:
      initEnabled: true
      hook: post-install
      backoffLimit: 6
      command: 
        - /bin/sh
        - /scripts/create.sh
      volumeMount:
        name: scripts
        mountPath: /scripts
      # env:
      #   - name: DB_PASSWORD
      #     value: "dbPassword"
      scriptData:
        create.sh: |-
          mysql -h ${mysql_name} -u root -p${mysql_root_password} ${keyrock_db_name} <<EOF

          -- Static objects
          SET @rules := JSON_ARRAY(
            JSON_OBJECT(
              "effect", "Permit"
            )
          );

          SET @subjectGold := "GOLD_CUSTOMER";
          SET @subjectStandard := "STANDARD_CUSTOMER";

          -- Policies Gold
          SET @policiesGold := JSON_ARRAY(
            JSON_OBJECT(
              "rules", CAST(@rules as JSON),
              "target", JSON_OBJECT(
                "actions", JSON_ARRAY("PATCH"),
                "resource", JSON_OBJECT(
                  "type", "DELIVERYORDER",
                  "attributes", JSON_ARRAY("pta","pda"),
                  "identifiers", JSON_ARRAY("*")
                )
              )
            ),
            JSON_OBJECT(
              "rules", CAST(@rules as JSON),
              "target", JSON_OBJECT(
                "actions", JSON_ARRAY("GET"),
                "resource", JSON_OBJECT(
                  "type", "DELIVERYORDER",
                  "attributes", JSON_ARRAY("*"),
                  "identifiers", JSON_ARRAY("*")
                )
              )
            )
          );

          -- Policies Standard
          SET @policiesStandard := JSON_ARRAY(
            JSON_OBJECT(
              "rules", CAST(@rules as JSON),
              "target", JSON_OBJECT(
                "actions", JSON_ARRAY("GET"),
                "resource", JSON_OBJECT(
                  "type", "DELIVERYORDER",
                  "attributes", JSON_ARRAY("*"),
                  "identifiers", JSON_ARRAY("*")
                )
              )
            )
          );

          -- Insert Delegation Evidence Gold VC
          SET @delegationGoldVC := JSON_OBJECT(
            "target", JSON_OBJECT(
              "accessSubject", @subjectGold
            ),
            "notBefore", 1616583866,
            "notOnOrAfter", 1735817171,
            "policyIssuer", ${did_domain},
            "policySets", JSON_ARRAY(
              JSON_OBJECT(
                "target", JSON_OBJECT(
                  "environment", JSON_OBJECT(
                    "licenses", JSON_ARRAY("ISHARE.0001")
                  )
                ),
                "policies", CAST(@policiesGold as JSON)
              )
            )
          );
          INSERT IGNORE INTO delegation_evidence (policy_issuer, access_subject,policy) VALUES (${did_domain}, @subjectGold, @delegationGoldVC);

          -- Insert Delegation Evidence Standard VC
          SET @delegationStandardVC := JSON_OBJECT(
            "target", JSON_OBJECT(
              "accessSubject", @subjectStandard
            ),
            "notBefore", 1616583866,
            "notOnOrAfter", 1735817171,
            "policyIssuer", ${did_domain},
            "policySets", JSON_ARRAY(
              JSON_OBJECT(
                "target", JSON_OBJECT(
                  "environment", JSON_OBJECT(
                    "licenses", JSON_ARRAY("ISHARE.0001")
                  )
                ),
                "policies", CAST(@policiesStandard as JSON)
              )
            )
          );
          INSERT IGNORE INTO delegation_evidence (policy_issuer, access_subject,policy) VALUES (${did_domain}, @subjectStandard, @delegationStandardVC);

          COMMIT;
          EOF

################################################################################


activation-service:

  # Enable the deployment of application: activation-service
  deploymentEnabled: ${activation_enable}

  activation-service:
    
    fullnameOverride: ${activation_name}
    
    ## Configuration of activation service execution
    activationService:
      # -- Number of (gunicorn) workers that should be created
      workers: 1
      # -- Maximum header size in bytes
      maxHeaderSize: 32768
      # -- Log Level
      logLevel: "debug"

    ## Add Ingress or OpenShift Route
    route:
      enabled: false

    ingress:
      enabled: ${activation_enable_ingress}
      annotations:
        cert-manager.io/cluster-issuer: letsencrypt-fiware-eks
        kubernetes.io/ingress.class: nginx
      hosts:
        - host: ips-as.dsba.aws.fiware.io
          paths:
            - /
      tls:
        - hosts:
            - ips-as.dsba.aws.fiware.io
          secretName: as-ips-dsba-tls

    ## CCS config
    ccs:
      endpoint: "http://ips-dsc-credentials-config-service:8080/"
      id: "ips-activation-service"
      defaultOidcScope: "default"
      oidcScopes:
        default:
          - type: "VerifiableCredential"
            trustedParticipantsLists: [
              "https://tir.dsba.fiware.dev"
            ]
            trustedIssuersLists: [
              "http://ips-dsc-trusted-issuers-list:8080"
            ]
          - type: "IpsActivationService"
            trustedParticipantsLists: [
              "https://tir.dsba.fiware.dev"
            ]
            trustedIssuersLists: [
              "http://ips-dsc-trusted-issuers-list:8080"
            ]

    ## AS config
    config:

      # DB
      db:
        # -- Use sqlite in-memory database
        useMemory: true
        # -- Enable tracking of modifications
        modTracking: false
        # -- Enable SQL logging to stderr
        echo: true

      # Configuration for additional API keys to protect certain endpoints
      apikeys:
        # Config for Trusted-Issuers-List flow
        issuer:
          # Header name
          headerName: "AS-API-KEY"
          # API key (auto-generated if left empty)
          apiKey: "77ab4a67-ea3c-4348-98bd-2e9f0304bfb8"
          # Enable for /issuer endpoint (API key will be required)
          enabledIssuer: true

      issuer:
        clientId: "ips-activation-service"
        providerId: ${did_domain}
        tilUri: "http://ips-dsc-trusted-issuers-list:8080"
        verifierUri: "https://ips-verifier.dsba.aws.fiware.io"
        samedevicePath: "/api/v1/samedevice"
        jwksPath: "/.well-known/jwks"
        algorithms:
          - "ES256"
        roles:
          createRole: "CREATE_ISSUER"
          updateRole: "UPDATE_ISSUER"
          deleteRole: "DELETE_ISSUER"


dsba-pdp:
  # Enable the deployment of application: dsba-pdp
  deploymentEnabled: false

  dsba-pdp:

    # DB
    db:
      enabled: false
      migrate:
        enabled: false

    deployment:
      # Log level
      logLevel: DEBUG

      # iSHARE config
      ishare:
        existingSecret: ${waltid_secret_tls}

        clientId: ${did_domain}

        # Initial list of fingerprints for trusted CAs. This will be overwritten
        # after the first update from the trust anchor.
        trustedFingerprints:
          - D2F62092F982CF783D4632BD86FA86C3FBFDB2D8C8A58BC6809163FCF5CD030B

        ar:
          id: ${did_domain}
          delegationPath: "/ar/delegation"
          tokenPath: "/oauth2/token"
          url: "https://ar-ips.dsba.aws.fiware.io"

        trustAnchor:
          id: "EU.EORI.FIWARESATELLITE"
          tokenPath: "/token"
          trustedListPath: "/trusted_list"
          url: "https://tir.dsba.fiware.dev"

      # Verifier
      trustedVerifiers:
        - https://ips-verifier.dsba.aws.fiware.io/.well-known/jwks

      # Provider DID
      providerId: ${did_domain}

    # ENVs
    additionalEnvVars:
      - name: ISHARE_CERTIFICATE_PATH
        value: /iShare/tls.crt
      - name: ISHARE_KEY_PATH
        value: /iShare/tls.key

kong:
  # Enable the deployment of application: kong
  deploymentEnabled: false

  kong:
    replicaCount: 1

    proxy:
      enabled: true
      tls:
        enabled: false

      # Provide Ingress or Route config here
      ingress:
        enabled: true
        annotations:
          kubernetes.io/ingress.class: nginx
          cert-manager.io/cluster-issuer: letsencrypt-fiware-eks
        ingressClassName: nginx
        tls: kong-ips-dsba-tls
        hostname: ips-kong.dsba.aws.fiware.io
      route:
        enabled: false

    # Provide the kong.yml configuration (either as existing CM, secret or directly in the values.yaml)
    dblessConfig:
      configMap: ""
      secret: ""
      config: |
        _format_version: "2.1"
        _transform: true

        consumers:
        - username: token-consumer
          keyauth_credentials:
          - tags:
            - token-key
            - tir-key

        services:
          - host: "ips-dsc-orion"
            name: "ips"
            port: 1026
            protocol: http

            routes:
              - name: ips
                paths:
                  - /ips
                strip_path: true

            plugins:
              - name: pep-plugin
                config:
                  pathprefix: "/ips"
                  authorizationendpointtype: ExtAuthz
                  authorizationendpointaddress: http://ips-dsc-dsba-pdp:8080/authz

              - name: request-transformer
                config:
                  remove:
                    headers:
                      - Authorization
                      - authorization
